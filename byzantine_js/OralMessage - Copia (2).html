<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <link type="text/css" rel="stylesheet" href="mystyle.css">
  <script src="jquery-main/dist/jquery.js"></script>
  <script src="cytoscape.js-master/dist/cytoscape.min.js"></script>
  <script src="style.js"></script>
  <title>OralMessages</title>
<script>
  let NUM_NODES;
  let traitors;
  let commander_is_traitor = false;
  let commander_value;
  let TIME = 500;
  let cy;
  let lieutenant_cy;
  let messages;
  let lieutenant_messages_receive = [];
  let cycle = 0;
  let INFO = [];
  function setNodes(){
    lieutenant_messages_receive = [NUM_NODES-1];
    document.getElementById("graph_creator").remove();
    cy = cytoscape({
          container: document.getElementById('cy'),
          elements: [
            { data: { id: 'Commander' } },
          ],

          style: [
            {
              selector: 'node',
              style: {
                shape: 'ellipse',
                'width': '40',
                'height': '40',
                'background-color': '#66ff33',
                'border-width': 1.5,
                label: 'data(id)',
              }
            }]
        });
    if(traitors[0] == 0) {
      commander_is_traitor = true;
      cy.nodes('[id = "Commander"]').style({'background-color': '#f54949'});
    }
    let is_loyal = true;
    for (let i = 1; i < NUM_NODES; i++) {
      is_loyal = true;
      for(let t = 0; t < traitors.length; t++){
        if(i == traitors[t]){
          is_loyal = false;
        }
      }
      if(!is_loyal){
        cy.add({
          data: { id: 'Lieutenant ' + i },
          style:{
            'background-color': '#f54949'
          }
        });
      }else{
        cy.add({
          data: { id: 'Lieutenant ' + i },
          style:{
            'background-color': '#66ff33'
          }
        });
      }
      const source = 'Lieutenant ' + i;
      cy.add({
        data: {
          id: 'edge' + i,
          source: source,
          target: ('Commander')
        },
        style: {
          'line-color': 'black',
          'opacity' : '0.5',
        }
      });
    }
    cy.layout({
      name: 'circle'
    }).run();

    for (let i = 1; i < NUM_NODES; i++) {
      const source = 'Lieutenant ' + i;
      for(let j = 1; j < NUM_NODES; j++){
        if(i!=j){
          cy.add({
            data: {
              id: 'edge' + i + ',' +j,
              source: source,
              target: 'Lieutenant ' + j
            },
            style: {
              'opacity' : '0.25',
              'line-color': 'black',
            }
          });
        }

      }
    }

    document.getElementById("sender").style.display = "inline";
    document.getElementById("skipMessages").style.display = "inline";
  }


  async function firstStep() {
    document.getElementById("skipMessages").style.display = "none";
    document.getElementById("sender").style.display = "none";
    let xC = cy.$('#Commander').position('x');
    let yC = cy.$('#Commander').position('y');
    let edge, lieutenant, msg, xGoal, yGoal, mid, j, value, label;
    let info = [];
    let tmp_info = [];
    let points = [];
    let color = '#66ff33';
    let lieutenant_messages;
    for (let i = 0; i < NUM_NODES-1; i++) {
      lieutenant_messages = messages[i];
      value = lieutenant_messages[0].value;
      j= i+1;
      label = value + ',0' + j;
      msg = '';
      msg += j;
      lieutenant_messages_receive[i] = 0;
      edge = 'edge' + j;
      lieutenant = 'Lieutenant ' + j;
      xGoal = cy.getElementById(lieutenant).position('x');
      yGoal = cy.getElementById(lieutenant).position('y');
      if(commander_is_traitor){
        color = '#f54949';
      }
      cy.add({
        data: {
          id: msg,
        },
        position: {x: xC, y: yC},
        style: {
          'display': 'none',
          'width': '50',
          'height': '22',
          shape: 'square',
          'background-color': 'white',
          'border-width': 1,
          'border-color': color,
          'text-halign': 'center',
          'text-valign': 'center',
          'label': label,
        }
      });
      tmp_info.push(!commander_is_traitor);
      tmp_info.push(msg);
      tmp_info.push(edge);
      points.push(xC);
      points.push(yC);
      mid = cy.getElementById(edge).midpoint();
      points.push(mid.x);
      points.push(mid.y);
      points.push(xGoal);
      points.push(yGoal);
      tmp_info.push(points);
      info.push(tmp_info);
      tmp_info= [];
      points =[];
    }

    cycle++;
    sends(info);
  }

  function nextStep(){
    document.getElementById("skipMessages").style.display = "none";
    document.getElementById("nextStep").style.display = 'none';
    let edge_name
    for (let i = 1; i < NUM_NODES; i++) {
      for(let j = 1; j < NUM_NODES; j++){
        edge_name = 'edge' + i + ',' + j;
        cy.getElementById(edge_name).style({
          'line-color': 'black',
          'opacity' : '0.25',
        });
      }
    }
    let node_name, msg, second_node_name, lieutenant_messages, senders, lieutenant_sender, message, j, label;
    let info = [];
    let node_cordinates = [];
    let tmp_info = [];
    let mid_cordinates = [];
    let sender_cordinates = [];
    let  messages_to_send= [];
    let points = [];
    let is_loyal = true;
    for(let i = 0; i < NUM_NODES-1; i++) {
      j= i+1;
      is_loyal = true;
      for(let t = 0; t < traitors.length; t++){
        if(j == traitors[t]){
          is_loyal = false;
          break;
        }
      }
      node_name = "Lieutenant " + j;
      node_cordinates = cy.getElementById(node_name).position();
      lieutenant_messages = messages[i];
      for(let z = 0; z < lieutenant_messages.length; z++){
        if(lieutenant_messages[z].cycle == cycle){
          messages_to_send.push(lieutenant_messages[z]);
        }
      }
      while(messages_to_send.length > 0) {
          msg = messages_to_send.pop();
          senders = msg.senders;
          lieutenant_sender = senders[senders.length-1];
          second_node_name = "Lieutenant " + lieutenant_sender;
          edge_name = "edge" + lieutenant_sender + ',' + j;
          lieutenant_messages_receive[i] = lieutenant_messages_receive[i] + 1;
          message ='';
          message += j.toString() + lieutenant_messages_receive[i].toString();
          //message = j + msg_receive[j-1] ++
          label = msg.value + ',[' + senders +']';
          sender_cordinates = cy.getElementById(second_node_name).position();
          cy.add({
            data: {
              id: message,
            },
            position: {x: sender_cordinates.x, y: sender_cordinates.y},
            style: {
              'display': 'none',
              'width': '65',
              'height': '22',
              shape: 'square',
              'background-color': 'white',
              'border-width': 1,
              'border-color': '#fff533',
              'text-halign': 'center',
              'text-valign': 'center',
              label: label,
            }
          });

        if(lieutenant_sender != j){
          tmp_info.push(is_loyal);
          tmp_info.push(message);
          tmp_info.push(edge_name);
          points.push(sender_cordinates.x);
          points.push(sender_cordinates.y);
          mid_cordinates = cy.getElementById(edge_name).midpoint();
          points.push(mid_cordinates.x);
          points.push(mid_cordinates.y);
          points.push(node_cordinates.x);
          points.push(node_cordinates.y);
          tmp_info.push(points);
          info.push(tmp_info);
        }
          points = [];
          tmp_info = [];

      }
    }
    cycle++;
    sends(info);
  }

  function sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
  }
  async function sends(infos){
    document.getElementById("increase_speed").style.display = 'inline';
    document.getElementById("decrease_speed").style.display = 'inline';
    document.getElementById("restart").style.display = "none";
    let stop = false;
    let name_node;
    let is_loyal, edge;
    let num_cycles = infos.length;
    for(let j = 0; j < num_cycles; j++) {
        if(!stop){
          let tmp_info = infos.shift();
        is_loyal = tmp_info.shift();
        name_node = tmp_info.shift();
        edge = tmp_info.shift();
        if (is_loyal) {
          cy.getElementById(edge).style({
            'opacity': '0.1',
            'line-color': 'green',
          });
        } else {
          cy.getElementById(edge).style({
            'line-color': 'red',
          });
        }
        let points = tmp_info.shift();
        cy.on('click', function (e) {
          clickOnGraphHandler(infos);
          document.getElementById("increase_speed").style.display = 'none';
          document.getElementById("decrease_speed").style.display = 'none';
          stop = true;
        });
        f(name_node, points);
        await sleep(TIME * points.length);
      }else{
          break;
        }
    }


    if(cycle<traitors.length+1 && !stop){
      document.getElementById("nextStep").style.display = "inline";
    }else if(!stop){
      document.getElementById("nextStep").style.display = "none";
      document.getElementById("restart").remove();
      cy.removeListener('click');
      showResults();
    }

    document.getElementById("increase_speed").style.display = 'none';
    document.getElementById("decrease_speed").style.display = 'none';
  }
  function f1(tmp_msg, tmp_points) {
    let tmp_x = tmp_points[0];
    tmp_points.shift();
    let tmp_y = tmp_points[0];
    tmp_points.shift();
    cy.getElementById(tmp_msg).position({
      y: tmp_y,
      x: tmp_x
    });
  }

  function f(tmp_msg, tmp_points) {
    cy.getElementById(tmp_msg).style({
      display: 'element',});
    f1(tmp_msg, tmp_points);
    setTimeout(function () {
      if (tmp_points.length > 0) {
        f(tmp_msg,tmp_points);
      }
    }, TIME);
  }

  async function resetDropArea(){
    await sleep(1000);
    const droparea = document.querySelector(".droparea");
    droparea.innerText = "Drop a valid JSON file here";
    droparea.classList.remove("invalid");
  }

  function setupAll(tmp){
    document.getElementById("drop").remove();
    document.getElementById("home_title").remove();
    document.getElementById("cy").style.display = "inline";
    NUM_NODES = tmp.num_nodes;
    messages = tmp.messages;
    if(tmp.traitors[0] == 0){
      commander_is_traitor = true;
    }else{
      commander_is_traitor = false;
    }
    traitors = tmp.traitors;
    setNodes();
  }
  async function showResults(){
    document.getElementById("increase_speed").style.display = 'none';
    document.getElementById("decrease_speed").style.display = 'none';
    document.getElementById("sender").style.display = "none";
    document.getElementById("skipMessages").style.display = "none";
    await sleep(500);
    document.getElementById("results").style.display = "inline";
    let j, tmp_msg;
    for(let i = 0; i < NUM_NODES; i++){
      j = i+1;
      tmp_msg = j.toString();
      cy.getElementById(tmp_msg).style({ display: 'none'});
      for(let z = 0; z <= lieutenant_messages_receive[i]; z++){
        tmp_msg = j.toString() + z.toString();
        cy.getElementById(tmp_msg).style({ display: 'none'});
      }
    }
    cy.on('click', 'node', function(e){
      if(this.id()!='Commander' && this.id()[0] == 'L'){
        document.getElementById("cy").style.display = "none";
        document.getElementById("results").style.display = "none";
        document.getElementById("lieutenant_cy").style.display = "inline";
        document.getElementById("back").style.display = "inline";
        createResultGraph(this.id());
      }
    });
  }

  function createResultGraph(id_node){
    let index = id_node[id_node.length-1] - 1;
    let node_messages = messages[index];
    let tmp = node_messages[0];
    let msg = '{ ' + tmp.value + ', [' + tmp.senders + '], ' + '? }';
    let l_cycle = 0;
    let label, parent ='';
    let node_name = '';
    for(s of tmp.senders){
      node_name+=s;
    }
    lieutenant_cy = cytoscape({
      container: document.getElementById('lieutenant_cy'),
      elements: [
        { data: { id: node_name } },
      ],
      position: {x: 0, y: 0},
      style: [
        {
          selector: 'node',
          style: {
            shape: 'square',
            'width': '100',
            'height': '40',
            'background-color': 'white',
            'border-width': 2,
            label: msg,
            'text-halign': 'center',
            'text-valign': 'center',
          }
        }]
    });
    l_cycle++;
    while(l_cycle <=  traitors.length) {
      for (let i = 1; i < node_messages.length; i++) {
        tmp = node_messages[i];
        if(l_cycle != traitors.length){
          label = '{' + tmp.value + ', [' + tmp.senders + '], ?}';
        }else{
          label = '{' + tmp.value + ', [' + tmp.senders + '], ' + tmp.finalValue + '}';
        }
        node_name = '';
        for(s of tmp.senders){
          node_name+=s;
        }
        if(tmp.cycle == l_cycle){
          lieutenant_cy.add({
            data: {
              id: node_name,
            },
            style: {
              'width': '100',
              'height': '40',
              shape: 'square',
              'background-color': 'white',
              'border-width': 1,
              'text-halign': 'center',
              'text-valign': 'center',
              label: label,
            }
          });
          parent = '';
          for(let z = 0; z < (tmp.senders).length-1; z++){
            parent+= tmp.senders[z];
          }
          lieutenant_cy.add({
            data: {
              id: 'edge' + node_name,
              source: parent,
              target: node_name,
            },
            style: {
              'opacity' : '0.50',
              'line-color': 'black',
            }
          });
        }
      }
      l_cycle++;
    }
    lieutenant_cy.layout({
      name: 'breadthfirst'
    }).run();
    lieutenant_cy.on('click', 'node', function(e){
      if(this.id().length - 1 != traitors.length){
          majority(this.id(), index);
      }
    });
  }

  function majority(id, index){
    let cycle = id.length - 1;
    let max = traitors.length;
    let node_messages = messages[index];
    let node_name;
    let string, color;
    let change = true;
    while(max >= cycle){
      for (let i = 0; i < node_messages.length; i++) {
          tmp = node_messages[i];
          label = '';
          if(tmp.cycle == max){
            node_name = '';
            for(s of tmp.senders){
              node_name+=s;
            }
            for(let j = 0; j < id.length; j++){
              if(node_name[j] != id[j]){
                change = false;
                break;
              }
            }
            if(change){
              string = '{' + tmp.value + ', [' + tmp.senders + '], ' + tmp.finalValue + '}'
              if(tmp.finalValue == 0){
                color = 'orange';
              }else{
                color = 'blue';
              }
              lieutenant_cy.getElementById(node_name).style({
                label: string,
                'border-color': color,
              });
              string = 'edge' + node_name;
              lieutenant_cy.getElementById(string).style({
                'line-color': color,
                'opacity' : '1',
              });
            }
            change = true;
          }
      }
      max--;
    }
  }
  function showGraph(){
    document.getElementById("lieutenant_cy").style.display = "none";
    document.getElementById("back").style.display = "none";
    lieutenant_cy.destroy();
    document.getElementById("cy").style.display = "inline";
    document.getElementById("results").style.display = "inline";
  }

  function increaseSpeed(){
    if(TIME >= 200){
      TIME -= 100;
    }else if (TIME > 10){
      TIME -=10;
    }
  }
  function decreaseSpeed(){
    TIME += 100;
  }

  function clickOnGraphHandler(infos){
    INFO = infos;
    document.getElementById("restart").style.display = "inline";
    return;
  }

  function restart(){
    sends(INFO);
  }
</script>
</head>

<body>

  <div id="drop" class = "droparea">Drop the JSON file here</div>
  <script>
    const droparea = document.querySelector(".droparea");
    droparea.addEventListener("dragover", (e)=> {
      e.preventDefault();
      droparea.classList.add("hover");
    });

    droparea.addEventListener("dragleave", ()=> {
      droparea.classList.remove("hover");
    });

    droparea.addEventListener("drop", (e) => {
      e.preventDefault();
      let fileJSON = e.dataTransfer.files[0];
      let reader = new FileReader();
      const type = fileJSON.type;
      let my_json;
      if(type == "application/json" || type == "JSON"  || type == "json"){
        const upload = (fileJson) => {
          droparea.setAttribute("class", "droparea valid");
          droparea.innerText = "Added " + fileJSON.name;
          reader.onloadend = function(e) {
            my_json = JSON.parse(this.result);
            console.log(my_json);
            setupAll(my_json);
          };
          reader.readAsText(fileJSON);
        };
        return upload(fileJSON);
      }else{
        droparea.setAttribute("class", "droparea invalid");
        droparea.innerText = "Invalid fail format";
        return resetDropArea();
      }
    });
  </script>
  <div id="cy"></div>
  <div id="lieutenant_cy"></div>
  <h1 id = "home_title"> Oral Message Flow</h1>
  <button id= "graph_creator" onclick = "setNodes()"> Create Graph </button>
  <button id= "sender" onclick = "firstStep()">Send Messages</button>
  <button id= "skipMessages" onclick = "showResults()"> Skip Messages </button>
  <button id="nextStep" onclick = "nextStep()">Next Iteration</button>
  <button id="back" onclick = "showGraph()">Back</button>
  <button id="restart" onclick="restart()">Restart</button>
  <a id="increase_speed"  onclick="increaseSpeed()" href= "#" class="bottone">+</a>
  <a id="decrease_speed"  onclick="decreaseSpeed()" href = "#" class="bottone">−</a>
  <div id="results">
    <h2>All iterations are terminated the lieutenants now can establish the final result!</h2>
    <h3>If you want see how the lieutenants decide the result, please click on the interested lieutenant</h3>
  </div>
  <h6 id = "creator">Created by Giuseppe Renna</h6>
</body>
</html>
